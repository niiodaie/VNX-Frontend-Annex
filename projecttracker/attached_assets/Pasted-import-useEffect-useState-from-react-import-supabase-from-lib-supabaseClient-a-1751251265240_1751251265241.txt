import { useEffect, useState } from "react";
import { supabase } from "../lib/supabaseClient"; // adjust path to your setup

export default function AssignRole() {
  const [users, setUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState("");
  const [selectedRole, setSelectedRole] = useState("");
  const [loading, setLoading] = useState(false);
  const roles = ["admin", "user", "viewer"];

  useEffect(() => {
    fetchUsers();
  }, []);

  async function fetchUsers() {
    const { data, error } = await supabase.from("profiles").select("id, display_name, role");
    if (error) console.error("Error fetching users:", error);
    else setUsers(data || []);
  }

  async function updateRole() {
    if (!selectedUser || !selectedRole) return;
    setLoading(true);
    const { error } = await supabase
      .from("profiles")
      .update({ role: selectedRole })
      .eq("id", selectedUser);

    if (error) alert("Error updating role: " + error.message);
    else {
      alert("Role updated!");
      fetchUsers();
    }

    setLoading(false);
  }

  return (
    <div className="max-w-md mx-auto mt-10 p-6 bg-white shadow rounded">
      <h2 className="text-xl font-bold mb-4">Assign Role</h2>
      
      <select
        value={selectedUser}
        onChange={(e) => setSelectedUser(e.target.value)}
        className="w-full mb-4 border p-2 rounded"
      >
        <option value="">Select a user</option>
        {users.map((user) => (
          <option key={user.id} value={user.id}>
            {user.display_name || user.id} ({user.role})
          </option>
        ))}
      </select>

      <select
        value={selectedRole}
        onChange={(e) => setSelectedRole(e.target.value)}
        className="w-full mb-4 border p-2 rounded"
      >
        <option value="">Select a role</option>
        {roles.map((role) => (
          <option key={role} value={role}>
            {role}
          </option>
        ))}
      </select>

      <button
        onClick={updateRole}
        disabled={loading}
        className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
      >
        {loading ? "Updating..." : "Update Role"}
      </button>
    </div>
  );
}
